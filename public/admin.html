<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GILMO'S PEOPLE - Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; }

    /* Login Screen */
    .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 40px; width: 360px; text-align: center; }
    .login-box h1 { color: #c9a55a; font-size: 20px; margin-bottom: 8px; letter-spacing: 2px; }
    .login-box p { color: #888; font-size: 13px; margin-bottom: 24px; }
    .login-box input { width: 100%; padding: 12px 16px; background: #111; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; outline: none; margin-bottom: 16px; }
    .login-box input:focus { border-color: #c9a55a; }
    .login-box button { width: 100%; padding: 12px; background: #c9a55a; color: #000; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #d4b06a; }
    .login-error { color: #ff6b6b; font-size: 13px; margin-bottom: 12px; }

    /* Header */
    .admin-header { background: #111; border-bottom: 1px solid #222; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .admin-header h1 { color: #c9a55a; font-size: 16px; letter-spacing: 2px; }
    .admin-header .stats { display: flex; gap: 16px; font-size: 13px; color: #888; }
    .admin-header .stats span { color: #c9a55a; font-weight: 600; }
    .btn-logout { background: none; border: 1px solid #555; color: #999; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .btn-logout:hover { border-color: #c9a55a; color: #c9a55a; }

    /* Filter Tabs */
    .filter-bar { padding: 16px 24px; display: flex; gap: 8px; border-bottom: 1px solid #1a1a1a; }
    .filter-tab { padding: 8px 16px; border-radius: 20px; border: 1px solid #333; background: transparent; color: #999; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .filter-tab.active { background: #c9a55a; color: #000; border-color: #c9a55a; font-weight: 600; }
    .filter-tab:hover:not(.active) { border-color: #c9a55a; color: #c9a55a; }

    /* Card Grid */
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; padding: 24px; }
    .card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; overflow: hidden; transition: border-color 0.2s; }
    .card:hover { border-color: #444; }
    .card-photos { display: flex; height: 200px; }
    .card-photos img { width: 50%; height: 100%; object-fit: cover; cursor: pointer; transition: opacity 0.2s; }
    .card-photos img:hover { opacity: 0.8; }
    .card-body { padding: 16px; }
    .card-name-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .card-name { font-size: 17px; font-weight: 600; color: #fff; }
    .card-gender { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .card-gender.male { background: rgba(74,158,255,0.15); color: #4a9eff; }
    .card-gender.female { background: rgba(255,107,157,0.15); color: #ff6b9d; }
    .card-status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; margin-left: auto; }
    .card-status-badge.pending { background: rgba(255,193,7,0.15); color: #ffc107; }
    .card-status-badge.approved { background: rgba(76,175,80,0.15); color: #4caf50; }
    .card-status-badge.rejected { background: rgba(244,67,54,0.15); color: #f44336; }
    .card-info { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 16px; font-size: 13px; margin-bottom: 14px; }
    .card-info dt { color: #777; }
    .card-info dd { color: #ccc; }
    .card-date { font-size: 11px; color: #555; margin-bottom: 12px; }
    .card-actions { display: flex; gap: 8px; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex: 1; }
    .btn-approve { background: #c9a55a; color: #000; }
    .btn-approve:hover { background: #d4b06a; }
    .btn-reject { background: transparent; border: 1px solid #555; color: #999; }
    .btn-reject:hover { border-color: #f44336; color: #f44336; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* SMS Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .sms-modal { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 28px; width: 440px; max-width: 95vw; }
    .sms-modal h3 { color: #c9a55a; font-size: 16px; margin-bottom: 4px; }
    .sms-modal .sms-to { color: #888; font-size: 13px; margin-bottom: 16px; }
    .sms-modal textarea { width: 100%; height: 160px; background: #111; border: 1px solid #333; border-radius: 8px; color: #e0e0e0; padding: 12px; font-size: 14px; resize: vertical; outline: none; font-family: inherit; line-height: 1.6; }
    .sms-modal textarea:focus { border-color: #c9a55a; }
    .sms-modal .char-count { text-align: right; font-size: 11px; color: #666; margin-top: 4px; margin-bottom: 16px; }
    .sms-modal .modal-actions { display: flex; gap: 8px; }
    .btn-send { background: #c9a55a; color: #000; padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1; }
    .btn-send:hover { background: #d4b06a; }
    .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-cancel { background: transparent; border: 1px solid #555; color: #999; padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; }
    .btn-cancel:hover { border-color: #c9a55a; color: #c9a55a; }
    .send-status { margin-top: 12px; font-size: 13px; text-align: center; }
    .send-status.success { color: #4caf50; }
    .send-status.error { color: #f44336; }

    /* Image Lightbox */
    .lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; }
    .lightbox img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; }

    /* Empty State */
    .empty-state { text-align: center; padding: 80px 20px; color: #555; }
    .empty-state p { font-size: 15px; }

    /* Loading */
    .loading { text-align: center; padding: 60px; color: #666; }

    @media (max-width: 600px) {
      .card-grid { grid-template-columns: 1fr; padding: 16px; }
      .admin-header { flex-wrap: wrap; gap: 8px; }
      .admin-header .stats { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===== Config =====
    // Credentials stored in localStorage (set on first login)
    let SUPABASE_URL = localStorage.getItem('admin_sb_url') || ''
    let SUPABASE_ANON_KEY = localStorage.getItem('admin_sb_key') || ''
    const ADMIN_PASSWORD = 'gilmo2026!'

    let supabaseClient = null
    let registrations = []
    let currentFilter = 'all'
    let smsModal = null   // { id, name, phone }
    let smsText = ''
    let smsSending = false
    let smsStatus = null  // { type: 'success'|'error', message }
    let lightboxUrl = null

    // ===== Init Supabase =====
    function initSupabase() {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    }

    // ===== Fetch Registrations =====
    async function fetchRegistrations() {
      const { data, error } = await supabaseClient
        .from('registrations')
        .select('*')
        .order('created_at', { ascending: false })

      if (error) {
        console.error('Fetch error:', error)
        return
      }
      registrations = data || []
      render()
    }

    // ===== Update Status =====
    async function updateStatus(id, status) {
      const { error } = await supabaseClient
        .from('registrations')
        .update({ status })
        .eq('id', id)

      if (error) {
        alert('상태 변경 실패: ' + error.message)
        return
      }

      const reg = registrations.find(r => r.id === id)
      if (reg) reg.status = status

      if (status === 'rejected') {
        render()
      }
    }

    // ===== Approve & Open SMS Modal =====
    function openSmsModal(reg) {
      updateStatus(reg.id, 'approved')
      const defaultMsg =
        `[GILMO'S PEOPLE] ${reg.name}님, 파티 참가가 승인되었습니다!\n\n` +
        `입금 안내:\n` +
        `- 계좌: [은행명] [계좌번호]\n` +
        `- 금액: [금액]원\n` +
        `- 예금주: [예금주명]\n\n` +
        `입금 확인 후 최종 안내 문자를 보내드립니다.`

      smsModal = { id: reg.id, name: reg.name, phone: reg.phone }
      smsText = defaultMsg
      smsSending = false
      smsStatus = null
      render()
    }

    // ===== Send SMS =====
    async function sendSms() {
      if (!smsModal || !smsText.trim()) return
      smsSending = true
      smsStatus = null
      render()

      try {
        const resp = await supabaseClient.functions.invoke('send-sms', {
          body: {
            phone: smsModal.phone,
            message: smsText,
            registrationId: smsModal.id,
          },
        })

        if (resp.error) throw new Error(resp.error.message || 'Edge Function error')

        const result = resp.data
        if (result.success) {
          smsStatus = { type: 'success', message: '문자 발송 완료!' }
          const reg = registrations.find(r => r.id === smsModal.id)
          if (reg) { reg.sms_sent = true; reg.sms_sent_at = new Date().toISOString() }
        } else {
          throw new Error(result.error || 'SMS 발송 실패')
        }
      } catch (err) {
        console.error('SMS error:', err)
        smsStatus = { type: 'error', message: '발송 실패: ' + err.message }
      }

      smsSending = false
      render()
    }

    // ===== Format Date =====
    function formatDate(dateStr) {
      if (!dateStr) return '-'
      const d = new Date(dateStr)
      return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`
    }

    function formatPhone(phone) {
      if (!phone) return '-'
      const d = phone.replace(/\D/g, '')
      if (d.length === 11) return `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`
      return phone
    }

    // ===== Render =====
    function render() {
      const app = document.getElementById('app')
      const isLoggedIn = sessionStorage.getItem('admin_logged_in') === 'true'

      if (!isLoggedIn) {
        app.innerHTML = renderLogin()
        return
      }

      const filtered = currentFilter === 'all'
        ? registrations
        : registrations.filter(r => (r.status || 'pending') === currentFilter)

      const counts = {
        all: registrations.length,
        pending: registrations.filter(r => !r.status || r.status === 'pending').length,
        approved: registrations.filter(r => r.status === 'approved').length,
        rejected: registrations.filter(r => r.status === 'rejected').length,
      }

      app.innerHTML = `
        <div class="admin-header">
          <h1>GILMO'S PEOPLE ADMIN</h1>
          <div class="stats">
            전체 <span>${counts.all}</span> |
            대기 <span>${counts.pending}</span> |
            승인 <span>${counts.approved}</span> |
            거절 <span>${counts.rejected}</span>
          </div>
          <button class="btn-logout" onclick="logout()">로그아웃</button>
        </div>

        <div class="filter-bar">
          ${['all','pending','approved','rejected'].map(f =>
            `<button class="filter-tab ${currentFilter === f ? 'active' : ''}" onclick="setFilter('${f}')">
              ${{all:'전체',pending:'대기중',approved:'승인',rejected:'거절'}[f]} (${counts[f]})
            </button>`
          ).join('')}
        </div>

        ${filtered.length === 0
          ? '<div class="empty-state"><p>신청 내역이 없습니다.</p></div>'
          : `<div class="card-grid">${filtered.map(renderCard).join('')}</div>`
        }

        ${smsModal ? renderSmsModal() : ''}
        ${lightboxUrl ? `<div class="lightbox" onclick="closeLightbox()"><img src="${escAttr(lightboxUrl)}" /></div>` : ''}
      `
    }

    function renderLogin() {
      const hasSavedConfig = SUPABASE_URL && SUPABASE_ANON_KEY
      return `
        <div class="login-screen">
          <div class="login-box">
            <h1>GILMO'S PEOPLE</h1>
            <p>관리자 페이지</p>
            <div id="login-error" class="login-error" style="display:none"></div>
            ${!hasSavedConfig ? `
              <input type="text" id="sb-url" placeholder="Supabase URL" value="${escHtml(SUPABASE_URL)}" style="margin-bottom:8px" />
              <input type="text" id="sb-key" placeholder="Supabase Anon Key" value="${escHtml(SUPABASE_ANON_KEY)}" style="margin-bottom:8px" />
            ` : ''}
            <input type="password" id="admin-pw" placeholder="비밀번호를 입력하세요" onkeydown="if(event.key==='Enter')doLogin()" />
            <button onclick="doLogin()">로그인</button>
            ${hasSavedConfig ? '<p style="margin-top:12px;font-size:11px;color:#555;cursor:pointer" onclick="resetConfig()">Supabase 설정 초기화</p>' : ''}
          </div>
        </div>
      `
    }

    function renderCard(reg) {
      const status = reg.status || 'pending'
      const statusLabel = { pending: '대기중', approved: '승인', rejected: '거절' }[status]
      const isPending = status === 'pending'

      return `
        <div class="card">
          <div class="card-photos">
            <img src="${escAttr(reg.body_photo_url || '')}" alt="전신" onclick="openLightbox('${escAttr(reg.body_photo_url || '')}')" />
            <img src="${escAttr(reg.face_photo_url || '')}" alt="얼굴" onclick="openLightbox('${escAttr(reg.face_photo_url || '')}')" />
          </div>
          <div class="card-body">
            <div class="card-name-row">
              <span class="card-name">${escHtml(reg.name)}</span>
              <span class="card-gender ${reg.gender}">${reg.gender === 'male' ? '남' : '여'}</span>
              <span class="card-status-badge ${status}">${statusLabel}</span>
            </div>
            <dl class="card-info">
              <dt>생년월일</dt><dd>${reg.birth_date || '-'}</dd>
              <dt>연락처</dt><dd>${formatPhone(reg.phone)}</dd>
              <dt>인스타</dt><dd>${escHtml(reg.instagram_id || '-')}</dd>
              <dt>신체</dt><dd>${reg.height || '-'}cm / ${reg.weight || '-'}kg</dd>
            </dl>
            <div class="card-date">신청일: ${formatDate(reg.created_at)}${reg.sms_sent ? ' | SMS 발송완료' : ''}</div>
            <div class="card-actions">
              ${isPending ? `
                <button class="btn btn-approve" onclick="openSmsModal(registrations.find(r=>r.id==='${reg.id}'))">승인 + 문자</button>
                <button class="btn btn-reject" onclick="rejectReg('${reg.id}')">거절</button>
              ` : status === 'approved' && !reg.sms_sent ? `
                <button class="btn btn-approve" onclick="openSmsModal(registrations.find(r=>r.id==='${reg.id}'))">문자 발송</button>
              ` : ''}
            </div>
          </div>
        </div>
      `
    }

    function renderSmsModal() {
      return `
        <div class="modal-overlay" onclick="closeSmsModal(event)">
          <div class="sms-modal" onclick="event.stopPropagation()">
            <h3>문자 발송</h3>
            <p class="sms-to">${escHtml(smsModal.name)} (${formatPhone(smsModal.phone)})</p>
            <textarea id="sms-textarea" oninput="updateSmsText(this.value)">${escHtml(smsText)}</textarea>
            <div class="char-count">${smsText.length}자 ${smsText.length > 90 ? '(LMS)' : '(SMS)'}</div>
            ${smsStatus && smsStatus.type === 'success' ? `
              <div class="send-status success">${escHtml(smsStatus.message)}</div>
              <div class="modal-actions">
                <button class="btn-send" onclick="closeSmsModalForce()">닫기</button>
              </div>
            ` : `
              <div class="modal-actions">
                <button class="btn-cancel" onclick="closeSmsModalForce()">취소</button>
                <button class="btn-send" onclick="sendSms()" ${smsSending ? 'disabled' : ''}>${smsSending ? '발송 중...' : '발송하기'}</button>
              </div>
              ${smsStatus ? `<div class="send-status ${smsStatus.type}">${escHtml(smsStatus.message)}</div>` : ''}
            `}
          </div>
        </div>
      `
    }

    // ===== Actions =====
    function doLogin() {
      const pw = document.getElementById('admin-pw').value
      // Save Supabase config if fields are present
      const urlInput = document.getElementById('sb-url')
      const keyInput = document.getElementById('sb-key')
      if (urlInput && keyInput) {
        SUPABASE_URL = urlInput.value.trim()
        SUPABASE_ANON_KEY = keyInput.value.trim()
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
          const err = document.getElementById('login-error')
          err.textContent = 'Supabase URL과 Anon Key를 입력해주세요.'
          err.style.display = 'block'
          return
        }
        localStorage.setItem('admin_sb_url', SUPABASE_URL)
        localStorage.setItem('admin_sb_key', SUPABASE_ANON_KEY)
      }

      if (pw === ADMIN_PASSWORD) {
        sessionStorage.setItem('admin_logged_in', 'true')
        initSupabase()
        fetchRegistrations()
      } else {
        const err = document.getElementById('login-error')
        err.textContent = '비밀번호가 올바르지 않습니다.'
        err.style.display = 'block'
      }
    }

    function resetConfig() {
      localStorage.removeItem('admin_sb_url')
      localStorage.removeItem('admin_sb_key')
      SUPABASE_URL = ''
      SUPABASE_ANON_KEY = ''
      render()
    }

    function logout() {
      sessionStorage.removeItem('admin_logged_in')
      registrations = []
      render()
    }

    function setFilter(f) {
      currentFilter = f
      render()
    }

    function rejectReg(id) {
      if (confirm('이 신청을 거절하시겠습니까?')) {
        updateStatus(id, 'rejected')
      }
    }

    function updateSmsText(val) { smsText = val; }

    function closeSmsModal(e) {
      if (e.target === e.currentTarget) closeSmsModalForce()
    }

    function closeSmsModalForce() {
      smsModal = null
      smsStatus = null
      render()
    }

    function openLightbox(url) {
      if (!url) return
      lightboxUrl = url
      render()
    }

    function closeLightbox() {
      lightboxUrl = null
      render()
    }

    function escHtml(str) {
      if (!str) return ''
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    }

    function escAttr(str) {
      if (!str) return ''
      return str.replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    }

    // ===== Init =====
    if (sessionStorage.getItem('admin_logged_in') === 'true' && SUPABASE_URL && SUPABASE_ANON_KEY) {
      initSupabase()
      fetchRegistrations()
    } else {
      sessionStorage.removeItem('admin_logged_in')
      render()
    }
  </script>
</body>
</html>
