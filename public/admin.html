<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MIDNIGHT IN SADANG - Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; }

    /* Login Screen */
    .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 40px; width: 360px; text-align: center; }
    .login-box h1 { color: #c9a55a; font-size: 20px; margin-bottom: 8px; letter-spacing: 2px; }
    .login-box p { color: #888; font-size: 13px; margin-bottom: 24px; }
    .login-box input { width: 100%; padding: 12px 16px; background: #111; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 14px; outline: none; margin-bottom: 16px; }
    .login-box input:focus { border-color: #c9a55a; }
    .login-box button { width: 100%; padding: 12px; background: #c9a55a; color: #000; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #d4b06a; }
    .login-error { color: #ff6b6b; font-size: 13px; margin-bottom: 12px; }

    /* Header */
    .admin-header { background: #111; border-bottom: 1px solid #222; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .admin-header h1 { color: #c9a55a; font-size: 16px; letter-spacing: 2px; }
    .admin-header .stats { display: flex; gap: 16px; font-size: 13px; color: #888; }
    .admin-header .stats span { color: #c9a55a; font-weight: 600; }
    .btn-logout { background: none; border: 1px solid #555; color: #999; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .btn-logout:hover { border-color: #c9a55a; color: #c9a55a; }

    /* Filter Tabs */
    .filter-bar { padding: 16px 24px; display: flex; gap: 8px; border-bottom: 1px solid #1a1a1a; }
    .filter-tab { padding: 8px 16px; border-radius: 20px; border: 1px solid #333; background: transparent; color: #999; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .filter-tab.active { background: #c9a55a; color: #000; border-color: #c9a55a; font-weight: 600; }
    .filter-tab:hover:not(.active) { border-color: #c9a55a; color: #c9a55a; }

    /* Card Grid */
    .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; padding: 24px; }
    .card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; overflow: hidden; transition: border-color 0.2s; }
    .card:hover { border-color: #444; }
    .card-photos { display: flex; height: 200px; }
    .card-photos img { width: 50%; height: 100%; object-fit: cover; cursor: pointer; transition: opacity 0.2s; }
    .card-photos img:hover { opacity: 0.8; }
    .card-body { padding: 16px; }
    .card-name-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .card-name { font-size: 17px; font-weight: 600; color: #fff; }
    .card-gender { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .card-gender.male { background: rgba(74,158,255,0.15); color: #4a9eff; }
    .card-gender.female { background: rgba(255,107,157,0.15); color: #ff6b9d; }
    .card-status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; margin-left: auto; }
    .card-status-badge.pending { background: rgba(255,193,7,0.15); color: #ffc107; }
    .card-status-badge.approved { background: rgba(76,175,80,0.15); color: #4caf50; }
    .card-status-badge.rejected { background: rgba(244,67,54,0.15); color: #f44336; }
    .card-info { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 16px; font-size: 13px; margin-bottom: 14px; }
    .card-info dt { color: #777; }
    .card-info dd { color: #ccc; }
    .card-date { font-size: 11px; color: #555; margin-bottom: 12px; }
    .card-actions { display: flex; gap: 8px; }
    .btn { padding: 8px 16px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex: 1; }
    .btn-approve { background: #c9a55a; color: #000; }
    .btn-approve:hover { background: #d4b06a; }
    .btn-reject { background: transparent; border: 1px solid #555; color: #999; }
    .btn-reject:hover { border-color: #f44336; color: #f44336; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* SMS Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .sms-modal { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 28px; width: 440px; max-width: 95vw; }
    .sms-modal h3 { color: #c9a55a; font-size: 16px; margin-bottom: 4px; }
    .sms-modal .sms-to { color: #888; font-size: 13px; margin-bottom: 16px; }
    .sms-modal textarea { width: 100%; height: 160px; background: #111; border: 1px solid #333; border-radius: 8px; color: #e0e0e0; padding: 12px; font-size: 14px; resize: vertical; outline: none; font-family: inherit; line-height: 1.6; }
    .sms-modal textarea:focus { border-color: #c9a55a; }
    .sms-modal .char-count { text-align: right; font-size: 11px; color: #666; margin-top: 4px; margin-bottom: 16px; }
    .sms-modal .modal-actions { display: flex; gap: 8px; }
    .btn-send { background: #c9a55a; color: #000; padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1; }
    .btn-send:hover { background: #d4b06a; }
    .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-cancel { background: transparent; border: 1px solid #555; color: #999; padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; }
    .btn-cancel:hover { border-color: #c9a55a; color: #c9a55a; }
    .send-status { margin-top: 12px; font-size: 13px; text-align: center; }
    .send-status.success { color: #4caf50; }
    .send-status.error { color: #f44336; }

    /* Image Lightbox */
    .lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; cursor: pointer; }
    .lightbox img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; }

    /* Empty State */
    .empty-state { text-align: center; padding: 80px 20px; color: #555; }
    .empty-state p { font-size: 15px; }

    /* Loading */
    .loading { text-align: center; padding: 60px; color: #666; }

    /* Approve Only Button */
    .btn-approve-only { background: transparent; border: 1px solid #c9a55a; color: #c9a55a; }
    .btn-approve-only:hover { background: rgba(201,165,90,0.15); }

    /* Event Counts Panel */
    .event-counts-panel { padding: 16px 24px; }
    .event-counts-panel h3 { color: #c9a55a; font-size: 14px; margin-bottom: 12px; letter-spacing: 1px; }
    .event-counts-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .event-count-card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; padding: 16px; text-align: center; }
    .event-count-date { font-size: 15px; font-weight: 700; color: #fff; margin-bottom: 10px; }
    .event-count-row { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 4px; }
    .event-count-gender { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .event-count-gender.male { background: rgba(74,158,255,0.15); color: #4a9eff; }
    .event-count-gender.female { background: rgba(255,107,157,0.15); color: #ff6b9d; }
    .event-count-num { font-size: 14px; font-weight: 600; color: #ccc; }
    .event-count-section { display: flex; flex-direction: column; gap: 6px; }
    .event-count-slash { color: #555; font-size: 13px; margin: 0 2px; }
    .event-count-num.max { color: #888; }
    .cnt-btn { width: 24px; height: 24px; border-radius: 6px; border: 1px solid #444; background: #222; color: #ccc; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
    .cnt-btn:hover { border-color: #c9a55a; color: #c9a55a; }
    .event-count-block-label { font-size: 10px; color: #666; margin-top: 10px; margin-bottom: 4px; letter-spacing: 0.5px; text-transform: uppercase; }
    .event-count-num.auto { color: #c9a55a; font-weight: 700; }
    .type-row { gap: 6px; flex-wrap: wrap; }
    .type-badge { font-size: 10px; padding: 2px 6px; border-radius: 6px; background: #222; color: #aaa; border: 1px solid #333; }
    .event-count-total { margin-top: 10px; font-size: 12px; color: #888; border-top: 1px solid #2a2a2a; padding-top: 8px; }

    @media (max-width: 600px) {
      .card-grid { grid-template-columns: 1fr; padding: 16px; }
      .admin-header { flex-wrap: wrap; gap: 8px; }
      .admin-header .stats { font-size: 12px; }
      .event-counts-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===== Config =====
    // Credentials stored in localStorage (set on first login)
    let SUPABASE_URL = localStorage.getItem('admin_sb_url') || ''
    let SUPABASE_ANON_KEY = localStorage.getItem('admin_sb_key') || ''
    const ADMIN_PASSWORD = 'midnight2026!'

    let supabaseClient = null
    let registrations = []
    let currentFilter = 'all'
    let smsModal = null   // { id, name, phone }
    let smsText = ''
    let smsSending = false
    let smsStatus = null  // { type: 'success'|'error', message }
    let lightboxUrl = null

    // ===== Init Supabase =====
    function initSupabase() {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    }

    // ===== Fetch Registrations =====
    async function fetchRegistrations() {
      const { data, error } = await supabaseClient
        .from('registrations')
        .select('*')
        .order('created_at', { ascending: false })

      if (error) {
        console.error('Fetch error:', error)
        return
      }
      registrations = data || []
      render()
    }

    // ===== Update Status =====
    async function updateStatus(id, status) {
      const reg = registrations.find(r => r.id === id)
      const prevStatus = reg ? reg.status : 'pending'

      const { error } = await supabaseClient
        .from('registrations')
        .update({ status })
        .eq('id', id)

      if (error) {
        alert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®: ' + error.message)
        return
      }

      if (reg) reg.status = status

      // ÏäπÏù∏ Ïãú event_settings Ïπ¥Ïö¥Ìä∏ ÏûêÎèô Ï¶ùÍ∞Ä
      if (status === 'approved' && prevStatus !== 'approved' && reg && reg.event_date) {
        const field = reg.gender === 'male' ? 'male_count' : 'female_count'
        let setting = eventSettings[reg.event_date]
        if (!setting) {
          await supabaseClient.from('event_settings').insert({
            event_date: reg.event_date, male_count: 0, female_count: 0, male_max: 24, female_max: 24
          })
          setting = { event_date: reg.event_date, male_count: 0, female_count: 0, male_max: 24, female_max: 24 }
          eventSettings[reg.event_date] = setting
        }
        const newVal = (setting[field] || 0) + 1
        setting[field] = newVal
        await supabaseClient.from('event_settings').update({ [field]: newVal }).eq('event_date', reg.event_date)
      }

      if (status === 'rejected') {
        render()
      }
    }

    // ===== Approve Only =====
    async function approveOnly(id) {
      await updateStatus(id, 'approved')
      render()
    }

    // ===== Approve & Open SMS Modal =====
    function openSmsModal(reg) {
      updateStatus(reg.id, 'approved')
      const defaultMsg =
        `[MIDNIGHT] ÏäπÏù∏ ÏïàÎÇ¥\n` +
        `${reg.name}Îãò, ÎØ∏ÎìúÎÇòÏûá(MIDNIGHT) Î©§Î≤ÑÎ°ú ÌôïÏ†ïÎêòÏÖ®ÏäµÎãàÎã§.\n` +
        `ÏïàÎÖïÌïòÏÑ∏Ïöî, Ìò∏Ïä§Ìä∏ 00ÏûÖÎãàÎã§.\n` +
        `Í∏∞ÎåÄÌïòÍ≥† Ïò§ÏãúÎäî ÎßåÌÅº, Ï¢ãÏùÄ ÎåÄÌôîÏôÄ ÎßåÎÇ®Ïù¥ Í∞ÄÎìùÌïú ÎØ∏ÎìúÎÇòÏûáÏùò Î∞§ÏùÑ ÏÑ†Î¨ºÌïòÍ≤†ÏäµÎãàÎã§.\n\n` +
        `‚ö†Ô∏è Ï†ïÏãú ÎèÑÏ∞© ÏïàÎÇ¥ (ÌïÑÎèÖ)\n` +
        `1Î∂Ä 'ÎØ∏ÎìúÎÇòÏûá Ïä§Ï∫î'ÏùÄ Î™®Îì† Î©§Î≤ÑÍ∞Ä ÎèôÏãúÏóê ÏãúÏûëÌïòÎäî ÌïµÏã¨ ÌîÑÎ°úÍ∑∏Îû®ÏûÖÎãàÎã§. ÏõêÌôúÌïú ÏßÑÌñâÏùÑ ÏúÑÌï¥ Î∞òÎìúÏãú Ï†ïÏãúÏóê ÎßûÏ∂∞ ÎèÑÏ∞©Ìï¥ Ï£ºÏÑ∏Ïöî. ÏßÄÏó∞ Ïãú ÌîÑÎ°úÍ∑∏Îû® Ï∞∏Ïó¨Í∞Ä Ïñ¥Î†§Ïö∏ Ïàò ÏûàÏäµÎãàÎã§.\n\n` +
        `üåô ÎîîÏßÄÌÑ∏ Ï¥àÎåÄÏû• (Ïû•ÏÜå/ÎìúÎ†àÏä§ÏΩîÎìú)\n` +
        `‚ñ∂ {ÎßÅÌÅ¨}\n\n` +
        `[Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏]\n` +
        `‚Ä¢ Ïã†Î∂ÑÏ¶ù ÌïÑÏàò (Ïã§Î¨º ÌòπÏùÄ Î™®Î∞îÏùº)\n` +
        `‚Ä¢ 10Î∂Ñ Ï†Ñ ÎèÑÏ∞© Í∂åÏû• (Ïó¨Ïú†Î°úÏö¥ ÏûÖÏû•ÏùÑ ÏúÑÌï¥)\n\n` +
        `ÏÑúÎ°úÏùò ÏãúÍ∞ÑÏùÑ Ï°¥Ï§ëÌïòÎäî ÎßàÏùåÏúºÎ°ú, Í∑∏ÎÇ† ÎØ∏ÎìúÎÇòÏûáÏóêÏÑú ÎµôÍ≤†ÏäµÎãàÎã§.`

      smsModal = { id: reg.id, name: reg.name, phone: reg.phone }
      smsText = defaultMsg
      smsSending = false
      smsStatus = null
      render()
    }

    // ===== Send SMS =====
    async function sendSms() {
      if (!smsModal || !smsText.trim()) return
      smsSending = true
      smsStatus = null
      render()

      try {
        const resp = await supabaseClient.functions.invoke('send-sms', {
          body: {
            phone: smsModal.phone,
            message: smsText,
            registrationId: smsModal.id,
          },
        })

        if (resp.error) throw new Error(resp.error.message || 'Edge Function error')

        const result = resp.data
        if (result.success) {
          smsStatus = { type: 'success', message: 'Î¨∏Ïûê Î∞úÏÜ° ÏôÑÎ£å!' }
          const reg = registrations.find(r => r.id === smsModal.id)
          if (reg) { reg.sms_sent = true; reg.sms_sent_at = new Date().toISOString() }
        } else {
          throw new Error(result.error || 'SMS Î∞úÏÜ° Ïã§Ìå®')
        }
      } catch (err) {
        console.error('SMS error:', err)
        smsStatus = { type: 'error', message: 'Î∞úÏÜ° Ïã§Ìå®: ' + err.message }
      }

      smsSending = false
      render()
    }

    // ===== Event Settings =====
    const EVENT_DATES_CONFIG = [
      { key: '2026-03-14', label: '3.14(ÌÜ†)' },
      { key: '2026-03-21', label: '3.21(ÌÜ†)' },
      { key: '2026-03-28', label: '3.28(ÌÜ†)' },
      { key: '2026-04-04', label: '4.4(ÌÜ†)' },
    ]

    let eventSettings = {}

    async function fetchEventSettings() {
      const { data } = await supabaseClient
        .from('event_settings')
        .select('*')
      if (data) {
        eventSettings = {}
        data.forEach(r => { eventSettings[r.event_date] = r })
      }
    }

    async function updateEventSetting(eventDate, field, delta) {
      let setting = eventSettings[eventDate]
      if (!setting) {
        await supabaseClient.from('event_settings').insert({
          event_date: eventDate, male_count: 0, female_count: 0, male_max: 24, female_max: 24
        })
        setting = { event_date: eventDate, male_count: 0, female_count: 0, male_max: 24, female_max: 24 }
        eventSettings[eventDate] = setting
      }
      const newVal = Math.max(0, (setting[field] || 0) + delta)
      setting[field] = newVal
      await supabaseClient.from('event_settings').update({ [field]: newVal }).eq('event_date', eventDate)
      render()
    }

    function getApprovedCounts() {
      const approved = registrations.filter(r => r.status === 'approved')
      const result = {}
      EVENT_DATES_CONFIG.forEach(ev => {
        const evRegs = approved.filter(r => r.event_date === ev.key)
        result[ev.key] = {
          male: evRegs.filter(r => r.gender === 'male').length,
          female: evRegs.filter(r => r.gender === 'female').length,
          '1+2Ï∞®': evRegs.filter(r => r.participation_type === '1+2Ï∞®').length,
          '1Î∂Ä': evRegs.filter(r => r.participation_type === '1Î∂Ä').length,
          '2Î∂Ä': evRegs.filter(r => r.participation_type === '2Î∂Ä').length,
        }
      })
      return result
    }

    function getEventCountsHtml() {
      const ac = getApprovedCounts()
      return EVENT_DATES_CONFIG.map(ev => {
        const s = eventSettings[ev.key] || { male_count: 0, female_count: 0, male_max: 24, female_max: 24 }
        const a = ac[ev.key] || { male: 0, female: 0, '1+2Ï∞®': 0, '1Î∂Ä': 0, '2Î∂Ä': 0 }
        return `
          <div class="event-count-card">
            <div class="event-count-date">${ev.label}</div>

            <div class="event-count-block-label">ÏäπÏù∏ ÌòÑÌô© (ÏûêÎèô)</div>
            <div class="event-count-section">
              <div class="event-count-row">
                <span class="event-count-gender male">ÎÇ®</span>
                <span class="event-count-num auto">${a.male}</span>
                <span class="event-count-gender female">Ïó¨</span>
                <span class="event-count-num auto">${a.female}</span>
              </div>
            </div>

            <div class="event-count-block-label">Ï∞∏Ïó¨Íµ¨Î∂Ñ</div>
            <div class="event-count-section">
              <div class="event-count-row type-row">
                <span class="type-badge">1+2Ï∞®</span><span class="event-count-num auto">${a['1+2Ï∞®']}</span>
                <span class="type-badge">1Î∂Ä</span><span class="event-count-num auto">${a['1Î∂Ä']}</span>
                <span class="type-badge">2Î∂Ä</span><span class="event-count-num auto">${a['2Î∂Ä']}</span>
              </div>
            </div>

            <div class="event-count-block-label">ÌôàÌéòÏù¥ÏßÄ ÌëúÏãú (ÏàòÎèô)</div>
            <div class="event-count-section">
              <div class="event-count-row">
                <span class="event-count-gender male">ÎÇ®</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','male_count',-1)">‚àí</button>
                <span class="event-count-num">${s.male_count}</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','male_count',1)">+</button>
                <span class="event-count-slash">/</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','male_max',-1)">‚àí</button>
                <span class="event-count-num max">${s.male_max}</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','male_max',1)">+</button>
              </div>
              <div class="event-count-row">
                <span class="event-count-gender female">Ïó¨</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','female_count',-1)">‚àí</button>
                <span class="event-count-num">${s.female_count}</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','female_count',1)">+</button>
                <span class="event-count-slash">/</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','female_max',-1)">‚àí</button>
                <span class="event-count-num max">${s.female_max}</span>
                <button class="cnt-btn" onclick="updateEventSetting('${ev.key}','female_max',1)">+</button>
              </div>
            </div>
            <div class="event-count-total">Ìï©Í≥Ñ ${s.male_count + s.female_count}/${s.male_max + s.female_max}</div>
          </div>
        `
      }).join('')
    }

    // ===== Format Date =====
    function formatDate(dateStr) {
      if (!dateStr) return '-'
      const d = new Date(dateStr)
      return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`
    }

    function formatPhone(phone) {
      if (!phone) return '-'
      const d = phone.replace(/\D/g, '')
      if (d.length === 11) return `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`
      return phone
    }

    // ===== Render =====
    function render() {
      const app = document.getElementById('app')
      const isLoggedIn = sessionStorage.getItem('admin_logged_in') === 'true'

      if (!isLoggedIn) {
        app.innerHTML = renderLogin()
        return
      }

      const filtered = currentFilter === 'all'
        ? registrations
        : registrations.filter(r => (r.status || 'pending') === currentFilter)

      const counts = {
        all: registrations.length,
        pending: registrations.filter(r => !r.status || r.status === 'pending').length,
        approved: registrations.filter(r => r.status === 'approved').length,
        rejected: registrations.filter(r => r.status === 'rejected').length,
      }

      app.innerHTML = `
        <div class="admin-header">
          <h1>MIDNIGHT IN SADANG ADMIN</h1>
          <div class="stats">
            Ï†ÑÏ≤¥ <span>${counts.all}</span> |
            ÎåÄÍ∏∞ <span>${counts.pending}</span> |
            ÏäπÏù∏ <span>${counts.approved}</span> |
            Í±∞Ï†à <span>${counts.rejected}</span>
          </div>
          <button class="btn-logout" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </div>

        <div class="filter-bar">
          ${['all','pending','approved','rejected'].map(f =>
            `<button class="filter-tab ${currentFilter === f ? 'active' : ''}" onclick="setFilter('${f}')">
              ${{all:'Ï†ÑÏ≤¥',pending:'ÎåÄÍ∏∞Ï§ë',approved:'ÏäπÏù∏',rejected:'Í±∞Ï†à'}[f]} (${counts[f]})
            </button>`
          ).join('')}
        </div>

        <div class="event-counts-panel">
          <h3>Ïù¥Î≤§Ìä∏Î≥Ñ ÏäπÏù∏ ÌòÑÌô©</h3>
          <div class="event-counts-grid">
            ${getEventCountsHtml()}
          </div>
        </div>

        ${filtered.length === 0
          ? '<div class="empty-state"><p>Ïã†Ï≤≠ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p></div>'
          : `<div class="card-grid">${filtered.map(renderCard).join('')}</div>`
        }

        ${smsModal ? renderSmsModal() : ''}
        ${lightboxUrl ? `<div class="lightbox" onclick="closeLightbox()"><img src="${escAttr(lightboxUrl)}" /></div>` : ''}
      `
    }

    function renderLogin() {
      const hasSavedConfig = SUPABASE_URL && SUPABASE_ANON_KEY
      return `
        <div class="login-screen">
          <div class="login-box">
            <h1>MIDNIGHT IN SADANG</h1>
            <p>Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ</p>
            <div id="login-error" class="login-error" style="display:none"></div>
            ${!hasSavedConfig ? `
              <input type="text" id="sb-url" placeholder="Supabase URL" value="${escHtml(SUPABASE_URL)}" style="margin-bottom:8px" />
              <input type="text" id="sb-key" placeholder="Supabase Anon Key" value="${escHtml(SUPABASE_ANON_KEY)}" style="margin-bottom:8px" />
            ` : ''}
            <input type="password" id="admin-pw" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" onkeydown="if(event.key==='Enter')doLogin()" />
            <button onclick="doLogin()">Î°úÍ∑∏Ïù∏</button>
            ${hasSavedConfig ? '<p style="margin-top:12px;font-size:11px;color:#555;cursor:pointer" onclick="resetConfig()">Supabase ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî</p>' : ''}
          </div>
        </div>
      `
    }

    function renderCard(reg) {
      const status = reg.status || 'pending'
      const statusLabel = { pending: 'ÎåÄÍ∏∞Ï§ë', approved: 'ÏäπÏù∏', rejected: 'Í±∞Ï†à' }[status]
      const isPending = status === 'pending'

      return `
        <div class="card">
          <div class="card-photos">
            <img src="${escAttr(reg.body_photo_url || '')}" alt="Ï†ÑÏã†" onclick="openLightbox('${escAttr(reg.body_photo_url || '')}')" />
            <img src="${escAttr(reg.face_photo_url || '')}" alt="ÏñºÍµ¥" onclick="openLightbox('${escAttr(reg.face_photo_url || '')}')" />
          </div>
          <div class="card-body">
            <div class="card-name-row">
              <span class="card-name">${escHtml(reg.name)}</span>
              <span class="card-gender ${reg.gender}">${reg.gender === 'male' ? 'ÎÇ®' : 'Ïó¨'}</span>
              <span class="card-status-badge ${status}">${statusLabel}</span>
            </div>
            <dl class="card-info">
              <dt>Ï∞∏Í∞ÄÎÇ†Ïßú</dt><dd>${reg.event_date || '-'}</dd>
              <dt>Ï∞∏Ïó¨Íµ¨Î∂Ñ</dt><dd>${escHtml(reg.participation_type || '-')}</dd>
              <dt>ÏÉùÎÖÑÏõîÏùº</dt><dd>${reg.birth_date || '-'}</dd>
              <dt>Ïó∞ÎùΩÏ≤ò</dt><dd>${formatPhone(reg.phone)}</dd>
              <dt>Í±∞Ï£ºÏßÄ</dt><dd>${escHtml(reg.location || '-')}</dd>
              <dt>ÏßÅÏóÖ</dt><dd>${escHtml(reg.job || '-')}</dd>
              <dt>Ïù∏Ïä§ÌÉÄ</dt><dd>${escHtml(reg.instagram_id || '-')}</dd>
              <dt>Ïã†Ï≤¥</dt><dd>${reg.height || '-'}cm / ${reg.weight || '-'}kg</dd>
              ${reg.charm ? `<dt>Îß§Î†•</dt><dd>${escHtml(reg.charm)}</dd>` : ''}
              ${reg.preferred_style ? `<dt>ÏÑ†Ìò∏</dt><dd>${escHtml(reg.preferred_style)}</dd>` : ''}
              ${reg.referral_source ? `<dt>Í≤ΩÎ°ú</dt><dd>${escHtml(reg.referral_source)}</dd>` : ''}
            </dl>
            <div class="card-date">Ïã†Ï≤≠Ïùº: ${formatDate(reg.created_at)}${reg.sms_sent ? ' | SMS Î∞úÏÜ°ÏôÑÎ£å' : ''}</div>
            <div class="card-actions">
              ${isPending ? `
                <button class="btn btn-approve-only" onclick="approveOnly('${reg.id}')">ÏäπÏù∏</button>
                <button class="btn btn-approve" onclick="openSmsModal(registrations.find(r=>r.id==='${reg.id}'))">ÏäπÏù∏ + Î¨∏Ïûê</button>
                <button class="btn btn-reject" onclick="rejectReg('${reg.id}')">Í±∞Ï†à</button>
              ` : status === 'approved' && !reg.sms_sent ? `
                <button class="btn btn-approve" onclick="openSmsModal(registrations.find(r=>r.id==='${reg.id}'))">Î¨∏Ïûê Î∞úÏÜ°</button>
              ` : ''}
            </div>
          </div>
        </div>
      `
    }

    function renderSmsModal() {
      return `
        <div class="modal-overlay" onclick="closeSmsModal(event)">
          <div class="sms-modal" onclick="event.stopPropagation()">
            <h3>Î¨∏Ïûê Î∞úÏÜ°</h3>
            <p class="sms-to">${escHtml(smsModal.name)} (${formatPhone(smsModal.phone)})</p>
            <textarea id="sms-textarea" oninput="updateSmsText(this.value)">${escHtml(smsText)}</textarea>
            <div class="char-count">${smsText.length}Ïûê ${smsText.length > 90 ? '(LMS)' : '(SMS)'}</div>
            ${smsStatus && smsStatus.type === 'success' ? `
              <div class="send-status success">${escHtml(smsStatus.message)}</div>
              <div class="modal-actions">
                <button class="btn-send" onclick="closeSmsModalForce()">Îã´Í∏∞</button>
              </div>
            ` : `
              <div class="modal-actions">
                <button class="btn-cancel" onclick="closeSmsModalForce()">Ï∑®ÏÜå</button>
                <button class="btn-send" onclick="sendSms()" ${smsSending ? 'disabled' : ''}>${smsSending ? 'Î∞úÏÜ° Ï§ë...' : 'Î∞úÏÜ°ÌïòÍ∏∞'}</button>
              </div>
              ${smsStatus ? `<div class="send-status ${smsStatus.type}">${escHtml(smsStatus.message)}</div>` : ''}
            `}
          </div>
        </div>
      `
    }

    // ===== Actions =====
    function doLogin() {
      const pw = document.getElementById('admin-pw').value
      // Save Supabase config if fields are present
      const urlInput = document.getElementById('sb-url')
      const keyInput = document.getElementById('sb-key')
      if (urlInput && keyInput) {
        SUPABASE_URL = urlInput.value.trim()
        SUPABASE_ANON_KEY = keyInput.value.trim()
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
          const err = document.getElementById('login-error')
          err.textContent = 'Supabase URLÍ≥º Anon KeyÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.'
          err.style.display = 'block'
          return
        }
        localStorage.setItem('admin_sb_url', SUPABASE_URL)
        localStorage.setItem('admin_sb_key', SUPABASE_ANON_KEY)
      }

      if (pw === ADMIN_PASSWORD) {
        sessionStorage.setItem('admin_logged_in', 'true')
        initSupabase()
        fetchRegistrations()
        fetchEventSettings()
      } else {
        const err = document.getElementById('login-error')
        err.textContent = 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.'
        err.style.display = 'block'
      }
    }

    function resetConfig() {
      localStorage.removeItem('admin_sb_url')
      localStorage.removeItem('admin_sb_key')
      SUPABASE_URL = ''
      SUPABASE_ANON_KEY = ''
      render()
    }

    function logout() {
      sessionStorage.removeItem('admin_logged_in')
      registrations = []
      render()
    }

    function setFilter(f) {
      currentFilter = f
      render()
    }

    function rejectReg(id) {
      if (confirm('Ïù¥ Ïã†Ï≤≠ÏùÑ Í±∞Ï†àÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        updateStatus(id, 'rejected')
      }
    }

    function updateSmsText(val) { smsText = val; }

    function closeSmsModal(e) {
      if (e.target === e.currentTarget) closeSmsModalForce()
    }

    function closeSmsModalForce() {
      smsModal = null
      smsStatus = null
      render()
    }

    function openLightbox(url) {
      if (!url) return
      lightboxUrl = url
      render()
    }

    function closeLightbox() {
      lightboxUrl = null
      render()
    }

    function escHtml(str) {
      if (!str) return ''
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    }

    function escAttr(str) {
      if (!str) return ''
      return str.replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    }

    // ===== Init =====
    if (sessionStorage.getItem('admin_logged_in') === 'true' && SUPABASE_URL && SUPABASE_ANON_KEY) {
      initSupabase()
      fetchRegistrations()
      fetchEventSettings()
    } else {
      sessionStorage.removeItem('admin_logged_in')
      render()
    }
  </script>
</body>
</html>
